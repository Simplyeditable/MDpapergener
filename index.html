<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LSPD Report Generator & Summary</title>
  <style>
    :root {
        --bg-color: #18191a;
        --text-color: #e4e6eb;
        --container-bg: #242526;
        --header-color: #45a1ff;
        --input-bg: #3a3b3c;
        --input-border: #555;
        --input-focus-border: #45a1ff;
        --output-bg: #3a3b3c;
        --hr-border: #3a3b3c;
        --button-bg: #007acc;
        --button-hover-bg: #0056b3;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 2rem;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
    }
    .container {
        width: 100%;
        max-width: 800px;
        background-color: var(--container-bg);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    h1, h2 {
        text-align: center;
        color: var(--header-color);
    }
    h3, h4 {
        color: var(--text-color);
        border-bottom: 2px solid var(--hr-border);
        padding-bottom: 0.5rem;
        margin-top: 2rem;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      color: var(--text-color);
    }
    textarea, input[type="text"], select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      box-sizing: border-box;
      transition: border-color 0.2s;
      background-color: var(--input-bg);
      color: var(--text-color);
    }
    textarea:focus, input[type="text"]:focus, select:focus {
        border-color: var(--input-focus-border);
        outline: none;
    }
    button, .button-link {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: bold;
      background-color: var(--button-bg);
      color: white !important;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    button:hover, .button-link:hover {
        background-color: var(--button-hover-bg);
    }
    button:disabled {
        background-color: #28a745;
        cursor: default;
    }
    .output-container {
      margin-top: 2rem;
    }
    .output-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .output {
      white-space: pre-wrap;
      background-color: var(--output-bg);
      padding: 1rem;
      border-radius: 6px;
      font-family: monospace;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--input-border);
      margin-top: 1rem;
      color: var(--text-color);
    }
    .copy-btn {
      background-color: #28a745;
    }
    .copy-btn:hover {
      background-color: #218838;
    }
    .copy-btn:disabled {
        background-color: #28a745;
    }
    .field-records-btn {
        background-color: #17a2b8;
    }
    .field-records-btn:hover {
        background-color: #138496;
    }
    .back-btn {
        background-color: #6c757d;
    }
    .back-btn:hover {
        background-color: #5a6268;
    }
    .danger-btn {
        background-color: #dc3545;
    }
    .danger-btn:hover {
        background-color: #c82333;
    }
    .inline-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .inline-buttons button {
        flex-grow: 1;
    }
    .dynamic-list-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .dynamic-list-row input {
      flex-grow: 1;
      margin-top: 0;
    }
    .remove-btn, .add-btn {
      padding: 0.5rem;
      font-size: 1rem;
      line-height: 1;
      margin-top: 0;
      flex-shrink: 0;
    }
    .remove-btn {
      background-color: #dc3545;
    }
    .remove-btn:hover {
        background-color: #c82333;
    }
    .add-btn {
        background-color: #28a745;
        width: 100%;
        margin-top: 0.5rem;
    }
    .add-btn:hover {
        background-color: #218838;
    }
    .form-section, #selection-menu {
        display: none;
    }
    #selection-menu {
        text-align: center;
    }
    #selection-menu button {
        width: 100%;
        margin-bottom: 1rem;
        padding: 1rem;
    }
    #summary-output, #all-reports-container {
        font-family: Arial, sans-serif;
        background-color: var(--container-bg);
        border: none;
    }
    .report-entry {
        background-color: var(--bg-color);
        border-left: 4px solid var(--button-bg);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
    }
    .report-entry .report-details {
        flex-grow: 1;
    }
    .report-entry .report-actions {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        flex-shrink: 0;
    }
    .report-entry .report-actions button {
        margin-top: 0;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    .report-entry .report-meta {
        font-size: 0.9em;
        font-weight: bold;
        color: #aaa;
        margin-bottom: 0.5rem;
    }
    #snackbar {
        visibility: hidden;
        min-width: 250px;
        margin-left: -125px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 2px;
        padding: 16px;
        position: fixed;
        z-index: 1;
        left: 50%;
        bottom: 30px;
        transition: visibility 0s, opacity 0.5s linear;
    }
    #snackbar.show {
        visibility: visible;
        opacity: 1;
    }
  </style>
</head>
<body>

<div class="container">
    <div id="selection-menu">
        <h1>LSPD Report Generator</h1>
        <p>Please select an option.</p>
        <button onclick="showForm('patrol-form')">Patrol Report</button>
        <button onclick="showForm('deployment-form')">Deployment Report</button>
        <button onclick="showForm('quick-parser-form')" style="background-color: #fd7e14;">Quick Report Parser</button>
        <button onclick="showForm('summary-form')" style="background-color: #17a2b8;">Monthly Summary</button>
        <button onclick="showForm('view-reports-form')" style="background-color: #6c757d;">View All Reports</button>
    </div>

    <div id="patrol-form" class="form-section">
        <h2>Metropolitan Patrol Report</h2>
        <button class="back-btn" onclick="showMenu()">Back to Menu</button>
        <h3>Patrol Information</h3>
        <label for="patrol-date">Date of Patrol</label>
        <input type="text" id="patrol-date" placeholder="DD/MMM/YYYY" />
        <div class="inline-buttons"><button type="button" onclick="setUTCDate('patrol-date')">Today (UTC+0)</button><button type="button" onclick="setUTCDate('patrol-date', -1)">Yesterday (UTC+0)</button></div>
        <h3>Officer Information</h3>
        <label>Involved Officers</label>
        <div id="patrol-officer-list" class="dynamic-list-container"></div>
        <button type="button" class="add-btn" onclick="addDynamicInput('patrol-officer-list', 'PLATOON RANK Firstname Lastname', 10)">+ Add Officer</button>
        <h3>Activity Information</h3>
        <label>Patrol Type</label>
        <div>
            <label><input type="checkbox" name="patrol-type" value="Canine Patrol" /> Canine Patrol</label>
            <label><input type="checkbox" name="patrol-type" value="SWAT Crime Suppression Patrol" /> SWAT Crime Suppression Patrol</label>
            <label><input type="checkbox" name="patrol-type" value="Joint Crime Suppression Patrol" /> Joint Crime Suppression Patrol</label>
            <label><input type="checkbox" name="patrol-type" value="Gang Crime Suppression Patrol" /> Gang Crime Suppression Patrol</label>
        </div>
        <label for="patrol-deployments">Deployments During Patrol</label>
        <textarea id="patrol-deployments" rows="3" placeholder="One per line: URL|Deployment type"></textarea>
        <label for="patrol-fieldActivity">Field Activity During Patrol</label>
        <textarea id="patrol-fieldActivity" rows="3" placeholder="One per line: URL|Activity type"></textarea>
        <label for="patrol-additional">Additional Information / Narrative</label>
        <textarea id="patrol-additional" rows="5"></textarea>
        <button onclick="generatePatrolBBCode(this)">Generate & Save Report</button>
        <div id="patrol-output-container" class="output-container" style="display:none;">
            <div class="output-buttons">
                <button class="copy-btn" onclick="copyToClipboard('patrol-output', this)">Copy to Clipboard</button>
                <a href="https://lspd.gta.world/viewforum.php?f=2146" target="_blank" class="button-link field-records-btn">Field Records</a>
            </div>
            <div id="patrol-output" class="output"></div>
        </div>
    </div>

    <div id="deployment-form" class="form-section">
        <h2>Metropolitan Division Deployment Report</h2>
        <button class="back-btn" onclick="showMenu()">Back to Menu</button>
        <h3>1. GENERAL INFORMATION</h3>
        <label>1.1 Involved Platoons</label>
        <div>
            <label><input type="checkbox" name="dep-plat" value="Canine Platoon" /> Canine Platoon</label>
            <label><input type="checkbox" name="dep-plat" value="D Platoon" /> D Platoon</label>
            <label><input type="checkbox" name="dep-plat" value="H Platoon" /> H Platoon</label>
			<label><input type="checkbox" name="dep-plat" value="UDU squad" /> UDU squad</label>
			<label><input type="checkbox" name="dep-plat" value="Bomb squad" /> Bomb squad</label>
        </div>
        <label>1.2 Incident Command</label>
        <label for="depl-ic" style="margin-top:0.5rem;">Incident Commander</label>
        <input type="text" id="depl-ic" placeholder="Incident Commander">
        <label for="depl-cn" style="margin-top:0.5rem;">Crisis Negotiator</label>
        <input type="text" id="depl-cn" placeholder="Crisis Negotiator">
        <label for="depl-tc">Tactical Commander</label>
        <input type="text" id="depl-tc" placeholder="Tactical Commander Name">
        <label>1.3 Involved Metropolitan Members</label>
        <div id="depl-members" class="dynamic-list-container"></div>
        <button type="button" class="add-btn" onclick="addDynamicInput('depl-members', 'RANK Firstname Lastname')">+ Add Member</button>
        <label for="depl-type">1.4 Deployment Type</label>
        <select id="depl-type"></select>
        <h3>2. DEPLOYMENT TIMELINE</h3>
        <label for="depl-date">2.1 Date</label>
        <input type="text" id="depl-date" placeholder="DD/MMM/YYYY" />
        <div class="inline-buttons"><button type="button" onclick="setUTCDate('depl-date')">Today (UTC+0)</button><button type="button" onclick="setUTCDate('depl-date', -1)">Yesterday (UTC+0)</button></div>
        <label for="depl-location">2.2 Location</label>
        <input type="text" id="depl-location" placeholder="e.g., San Andreas Avenue, Vespucci">
        <label>2.3 Timeline</label>
        <input type="text" id="depl-start-time" placeholder="Start of Deployment (24h format, e.g., 14:30)">
        <div class="inline-buttons"><button type="button" onclick="setUTCTime('depl-start-time')">Now (UTC+0)</button><button type="button" onclick="setUTCTime('depl-start-time', -1)">One hour ago (UTC+0)</button></div>
        <input style="margin-top: 0.5rem;" type="text" id="depl-end-time" placeholder="End of Deployment (24h format, e.g., 16:00)">
        <div class="inline-buttons"><button type="button" onclick="setUTCTime('depl-end-time')">Now (UTC+0)</button></div>
        <h3>3. CASUALTY & INJURY INFORMATION</h3>
        <label>3.1 Injured Team Members</label>
        <div id="depl-injured" class="dynamic-list-container"></div>
        <button type="button" class="add-btn" onclick="addDynamicInput('depl-injured', 'RANK Name - Injury Details')">+ Add Injured Member</button>
        <label>3.2 Suspect Casualties</label>
        <div id="depl-suspects" class="dynamic-list-container"></div>
        <button type="button" class="add-btn" onclick="addDynamicInput('depl-suspects', 'Details of suspect casualty')">+ Add Suspect Casualty</button>
        <label>3.3 Civilian Casualties</label>
        <div id="depl-civilians" class="dynamic-list-container"></div>
        <button type="button" class="add-btn" onclick="addDynamicInput('depl-civilians', 'Details of civilian casualty')">+ Add Civilian Casualty</button>
        <h3>4. FILING OFFICER</h3>
        <label for="depl-signature">Filing Officer Signature</label>
        <input type="text" id="depl-signature" placeholder="Firstname Lastname">
        <button onclick="generateDeploymentBBCode(this)">Generate & Save Report</button>
        <div id="deployment-output-container" class="output-container" style="display:none;">
            <div class="output-buttons">
                <button class="copy-btn" onclick="copyToClipboard('deployment-output', this)">Copy to Clipboard</button>
                <a href="https://lspd.gta.world/viewforum.php?f=2146" target="_blank" class="button-link field-records-btn">Field Records</a>
            </div>
            <div id="deployment-output" class="output"></div>
        </div>
    </div>

    <div id="quick-parser-form" class="form-section">
        <h2>Quick Report Parser</h2>
        <button class="back-btn" onclick="showMenu()">Back to Menu</button>
        <p>Paste your personnel list and timeline below to quickly save a deployment record for your summary calculations.</p>
        <label for="parser-deployment-type">Deployment Type</label>
        <select id="parser-deployment-type"></select>
        <label for="parser-personnel-input">Personnel List</label>
        <textarea id="parser-personnel-input" rows="8" placeholder="Paste the list of all involved personnel here, one per line."></textarea>
        <label for="parser-timeline-input">Timeline & Narrative</label>
        <textarea id="parser-timeline-input" rows="12" placeholder="Paste the full timeline here, including '2.1 DATE:', 'START OF DEPLOYMENT:', and 'END OF DEPLOYMENT:' lines."></textarea>
        <button onclick="parseAndSaveQuickReport(this)">Parse and Save Report</button>
    </div>

    <div id="summary-form" class="form-section">
        <h2>Monthly Summary</h2>
        <button class="back-btn" onclick="showMenu()">Back to Menu</button>
        <label for="summary-name-exclusion">Name(s) to Exclude from Summary (comma separated)</label>
        <input type="text" id="summary-name-exclusion" placeholder="e.g., John Doe, Jane Smith">
        <button onclick="generateSummary()">Calculate Summary</button>
        <div id="summary-output-container" class="output-container" style="display:none;">
            <div id="summary-output" class="output"></div>
        </div>
        <hr style="margin-top: 2rem;"/>
        <h3>Manage Data</h3>
        <p>This will permanently delete all saved reports from your browser. This action cannot be undone.</p>
        <button class="danger-btn" onclick="clearAllData()">Clear All Saved Data</button>
    </div>

    <div id="view-reports-form" class="form-section">
        <h2>View All Saved Reports</h2>
        <button class="back-btn" onclick="showMenu()">Back to Menu</button>
        <div id="all-reports-container" class="output-container"></div>
    </div>
</div>

<div id="snackbar"></div>

<script>
    const reportStorageKey = 'lspdReports';
    const patrolFormKey = 'patrolFormData';
    const deploymentFormKey = 'deploymentFormData';
    const summaryExclusionKey = 'summaryExclusion';
    const deploymentTypes = [
        "Search Warrant Execution", "High Risk Arrest Warrant Execution", "High Risk Crime Suppression Patrol",
        "Property Search", "Vehicle Search", "Area Search", "Property Alarm", "Civil Disturbance Deployment",
        "Riot Control Deployment", "Protest Demonstration", "Event Deployment", "Active Drive-by Deployment",
        "Active Shooter Deployment", "Barricaded Suspect", "Protection Detail", "Manhunt", "Panic Alarm",
        "Officer Needs Help Response", "TAC-ALERT", "Scene Security", "Mobile Kidnapping", "Hostage Situation",
        "Covert Operation", "Bomb Threat", "Suspicious Package", "Bomb Disposal", "Explosive Device Investigation",
        "Explosive Ordnance Disposal", "IED Incident", "Explosive Materials Incident", "Detonation of Explosives",
        "Explosive Device Safety Assessment"
    ];

    // --- NAVIGATION ---
    function showForm(formId) {
        document.querySelectorAll('.form-section, #selection-menu').forEach(el => el.style.display = 'none');
        document.getElementById(formId).style.display = 'block';
        if (formId === 'view-reports-form') displayAllReports();
    }

    function showMenu() {
        document.querySelectorAll('.form-section, #selection-menu').forEach(el => el.style.display = 'none');
        document.getElementById('selection-menu').style.display = 'block';
    }
    
    // --- NOTIFICATION SYSTEM ---
    function showSnackbar(message) {
        const snackbar = document.getElementById("snackbar");
        snackbar.textContent = message;
        snackbar.className = "show";
        setTimeout(() => { snackbar.className = snackbar.className.replace("show", ""); }, 3000);
    }

    // --- DATA PERSISTENCE ---
    function saveReport(reportData) {
        try {
            let reports = JSON.parse(localStorage.getItem(reportStorageKey)) || [];
            reports.push(reportData);
            localStorage.setItem(reportStorageKey, JSON.stringify(reports));
            return true;
        } catch (e) { 
            console.error("Failed to save report:", e); 
            showSnackbar("Error: Could not save report.");
            return false;
        }
    }

    function clearAllData() {
        if (confirm("Are you sure you want to delete ALL saved reports? This cannot be undone.")) {
            localStorage.removeItem(reportStorageKey);
            showSnackbar("All saved data has been cleared.");
            if (document.getElementById('summary-form').style.display === 'block') generateSummary();
            if (document.getElementById('view-reports-form').style.display === 'block') displayAllReports();
        }
    }
    
    function deleteReport(timestamp) {
        if (confirm("Are you sure you want to delete this report?")) {
            let reports = JSON.parse(localStorage.getItem(reportStorageKey)) || [];
            localStorage.setItem(reportStorageKey, JSON.stringify(reports.filter(r => r.timestamp !== timestamp)));
            showSnackbar("Report deleted.");
            displayAllReports();
        }
    }

    function saveFormData(formId, storageKey) {
        const form = document.getElementById(formId);
        const data = {};
        form.querySelectorAll('input[type="text"], textarea, select').forEach(el => { data[el.id] = el.value; });
        form.querySelectorAll('input[type="checkbox"]').forEach(el => {
            if (!data[el.name]) data[el.name] = {};
            data[el.name][el.value] = el.checked;
        });
        form.querySelectorAll('.dynamic-list-container').forEach(c => { data[c.id] = getDynamicListValues(c.id, true); });
        localStorage.setItem(storageKey, JSON.stringify(data));
    }

    function loadFormData(formId, storageKey) {
        const savedData = localStorage.getItem(storageKey);
        if (!savedData) return;
        const form = document.getElementById(formId);
        const data = JSON.parse(savedData);
        form.querySelectorAll('input[type="text"], textarea, select').forEach(el => { if (data[el.id]) el.value = data[el.id]; });
        form.querySelectorAll('input[type="checkbox"]').forEach(el => { if (data[el.name] && data[el.name][el.value]) el.checked = true; });
        form.querySelectorAll('.dynamic-list-container').forEach(container => {
            container.innerHTML = '';
            if (data[container.id]) data[container.id].forEach(value => addDynamicInput(container.id, '...', 100, value));
        });
    }

    // --- SHARED HELPER FUNCTIONS ---
    function getUTCDate(offsetDays = 0) {
        const date = new Date();
        date.setUTCDate(date.getUTCDate() + offsetDays);
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = date.toLocaleString('en-US', { month: 'short', timeZone: 'UTC' }).toUpperCase();
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
    }

    function setUTCDate(elementId, offset = 0) {
        document.getElementById(elementId).value = getUTCDate(offset);
        const form = document.getElementById(elementId).closest('.form-section');
        if (form.id === 'patrol-form') saveFormData('patrol-form', patrolFormKey);
        else if (form.id === 'deployment-form') saveFormData('deployment-form', deploymentFormKey);
    }

    function getUTCTime(offsetHours = 0) {
        const date = new Date();
        date.setUTCHours(date.getUTCHours() + offsetHours);
        const hours = String(date.getUTCHours()).padStart(2, '0');
        const minutes = String(date.getUTCMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    function setUTCTime(elementId, offset = 0) {
        document.getElementById(elementId).value = getUTCTime(offset);
        const form = document.getElementById(elementId).closest('.form-section');
        if (form.id === 'deployment-form') saveFormData('deployment-form', deploymentFormKey);
    }
    
    function copyToClipboard(elementId, button) {
        let textToCopy = elementId;
        if (document.getElementById(elementId)) {
            textToCopy = document.getElementById(elementId).textContent;
        }
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.disabled = true;
            setTimeout(() => { button.textContent = originalText; button.disabled = false; }, 2000);
        });
    }

    function addDynamicInput(containerId, placeholder, maxItems = 100, value = '') {
        const container = document.getElementById(containerId);
        if (container.children.length >= maxItems) return;
        const row = document.createElement('div');
        row.className = 'dynamic-list-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = placeholder;
        input.value = value;
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = '-';
        removeBtn.className = 'remove-btn';
        removeBtn.onclick = () => {
            row.remove();
            const form = container.closest('.form-section');
            if (form.id === 'patrol-form') saveFormData('patrol-form', patrolFormKey);
            else if (form.id === 'deployment-form') saveFormData('deployment-form', deploymentFormKey);
        };
        row.appendChild(input);
        row.appendChild(removeBtn);
        container.appendChild(row);
    }

    function getDynamicListValues(containerId, asArray = false) {
        const container = document.getElementById(containerId);
        const inputs = container.querySelectorAll('.dynamic-list-row input');
        const values = Array.from(inputs).map(input => input.value.trim()).filter(Boolean);
        return asArray ? values : values.map(v => `[*] ${v}`).join('\n');
    }
    
    function provideSaveFeedback(button) {
        const originalText = button.textContent;
        button.textContent = 'Saved!';
        button.disabled = true;
        showSnackbar("Report saved successfully!");
        setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
        }, 2000);
    }

    // --- PAGE LOAD INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const deplTypeSelects = [document.getElementById('depl-type'), document.getElementById('parser-deployment-type')];
        deplTypeSelects.forEach(select => {
            deploymentTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                select.appendChild(option);
            });
        });
        showMenu();
        loadFormData('patrol-form', patrolFormKey);
        loadFormData('deployment-form', deploymentFormKey);
        const savedExclusion = localStorage.getItem(summaryExclusionKey);
        if (savedExclusion) document.getElementById('summary-name-exclusion').value = savedExclusion;
        document.getElementById('patrol-form').addEventListener('input', () => saveFormData('patrol-form', patrolFormKey));
        document.getElementById('deployment-form').addEventListener('input', () => saveFormData('deployment-form', deploymentFormKey));
    });

    // --- BBCODE BUILDERS ---
    function buildPatrolBBCode(report) {
        const officers = (report.officers || []).map(o => ` ${o}`).join('\n');
        const allPatrolTypes = [
			"Canine Patrol",
			"SWAT Crime Suppression Patrol",
			"Joint Crime Suppression Patrol",
			"Gang Crime Suppression Patrol"
		];
		const checkedTypes = report.patrolTypes || [];
		const patrolTypes = allPatrolTypes.map(type => {
			if (checkedTypes.includes(type)) {
				return `[cbc] ${type}`;
			} else {
				return `[cb] ${type}`;
			}
		}).join("\n");
        const deploymentsRaw = (report.deploymentsRaw || "").split("\n");
        const fieldActivityRaw = (report.fieldActivityRaw || "").split("\n");
        const deploymentBB = deploymentsRaw.map(line => { const [url, label] = line.split("|"); return url && label ? `[url=${url.trim()}]${label.trim()}[/url]` : ''; }).filter(Boolean).join("\n") || "N/A";
        const fieldActivityBB = fieldActivityRaw.map(line => { const [url, label] = line.split("|"); return url && label ? `[url=${url.trim()}]${label.trim()}[/url]` : ''; }).filter(Boolean).join("\n") || "N/A";
        return `[divbox2=transparent][font=Arial][center]LOS SANTOS POLICE DEPARTMENT
[size=120][b]METROPOLITAN DIVISION
PATROL REPORT[/b][/size][/center]

[b]1. Date of Patrol[/b]
${report.date || 'N/A'}

[b]2. Officers[/b]
[list]
${officers}
[/list]
[b]3. Patrol Type[/b]
${patrolTypes}

[b]4. Deployments[/b]
${deploymentBB}

[b]5. Additional Information[/b]
${report.additional || 'N/A'}[/font][/divbox2]`;
    }

    function buildDeploymentBBCode(report) {
        const platoons = (report.platoons || []).map(p => `[*] ${p}`).join('\n') || "[*] N/A";
        const members = (report.members || []).map(m => `[*] ${m}`).join('\n');
        const injured = (report.injured || []).map(i => `[*] ${i}`).join('\n') || "[*] N/A";
        const suspects = (report.suspects || []).map(s => `[*] ${s}`).join('\n') || "[*] N/A";
        const civilians = (report.civilians || []).map(c => `[*] ${c}`).join('\n') || "[*] N/A";
        return `[divbox2=transparent]\n[aligntable=right,350,0,0,0,0,0][center][lspdlogo=150][/lspdlogo][metrologo=150][/metrologo][/center][/aligntable]\n[br][/br]\n[center][size=170][b]METROPOLITAN DIVISION[/b][/size]\n[size=150]DEPLOYMENT REPORT[/size][/center]\n[br]\n[divbox=black][b][size=150][color=#FFFFFF]1. GENERAL INFORMATION[/color][/size][/b][/divbox]\n[indent=10][u]1.1[/u] [b]INVOLVED PLATOONS:[/b]\n[list]${platoons}[/list]\n[u]1.2[/u] [b]INCIDENT COMMAND:[/b]\n[list][*] [b]INCIDENT COMMANDER (if applicable):[/b] ${report.ic || 'N/A'}\n[*] [b]CRISIS NEGOTIATOR (if applicable):[/b] ${report.cn || 'N/A'}\n[*] [b]TACTICAL COMMANDER:[/b] ${report.tc || 'N/A'}\n[/list]\n[u]1.3[/u] [b]INVOLVED METROPOLITAN MEMBERS: [/b]\n[list]${members}[/list]\n[u]1.4[/u] [b]DEPLOYMENT TYPE:[/b] ${report.deploymentType}\n[/indent]\n[divbox=black][b][size=150][color=#FFFFFF]2. DEPLOYMENT TIMELINE[/color][/size][/b][/divbox]\n[indent=10][u]2.1[/u] [b]DATE:[/b] ${report.date || 'N/A'}\n[u]2.2[/u] [b]LOCATION:[/b] ${report.location || 'N/A'}\n[u]2.3[/u] [b]TIMELINE:[/b]\n[list][*][b]START OF DEPLOYMENT:[/b] ${report.startTime || 'N/A'}\n[*][b]END OF DEPLOYMENT:[/b] ${report.endTime || 'N/A'}[/list][/indent]\n[divbox=black][b][size=150][color=#FFFFFF]3. CASUALTY & INJURY INFORMATION[/color][/size][/b][/divbox]\n[indent=10][u]3.1[/u] [b]INJURED TEAM MEMBERS:[/b]\n[list]${injured}[/list]\n[u]3.2[/u] [b]SUSPECT CASUALTIES:[/b]\n[list]${suspects}[/list]\n[u]3.3[/u] [b]CIVILIAN CASUALTIES:[/b]\n[list]${civilians}[/list]\n[br][/br]\n[divbox=black][/divbox]\n[br][/br]\n[aligntable=left,200,0,0,0,0,0][center][b]FILING OFFICER SIGNATURE[/b]\n[i]${report.signature || ' '}[/i][/center][/aligntable]\n[br][/br][br][/br][/divbox2]`;
    }

    // --- REPORTING LOGIC ---
    function generatePatrolBBCode(button) {
        const patrolReportData = {
            type: 'Patrol',
            date: document.getElementById("patrol-date").value,
            officers: getDynamicListValues('patrol-officer-list', true),
            patrolTypes: Array.from(document.querySelectorAll('[name="patrol-type"]:checked')).map(cb => cb.value),
            deploymentsRaw: document.getElementById("patrol-deployments").value,
            fieldActivityRaw: document.getElementById("patrol-fieldActivity").value,
            additional: document.getElementById("patrol-additional").value,
            timestamp: new Date().toISOString()
        };
        if (!patrolReportData.officers.length) {
            return showSnackbar("Error: Please fill in at least one officer.");
        }
        if (saveReport(patrolReportData)) {
            provideSaveFeedback(button);
        }
        const bbcode = buildPatrolBBCode(patrolReportData);
        const outputContainer = document.getElementById("patrol-output-container");
        document.getElementById("patrol-output").textContent = bbcode;
        outputContainer.style.display = 'block';
        outputContainer.scrollIntoView({ behavior: 'smooth' });
        localStorage.removeItem(patrolFormKey);
        document.getElementById("patrol-form").reset();
        document.getElementById("patrol-officer-list").innerHTML = '';
    }

    function generateDeploymentBBCode(button) {
        const deploymentReportData = {
            type: 'Deployment',
            platoons: Array.from(document.querySelectorAll('[name="dep-plat"]:checked')).map(cb => cb.value),
            ic: document.getElementById('depl-ic').value,
            cn: document.getElementById('depl-cn').value,
            tc: document.getElementById('depl-tc').value,
            members: getDynamicListValues('depl-members', true),
            deploymentType: document.getElementById('depl-type').value,
            date: document.getElementById('depl-date').value,
            location: document.getElementById('depl-location').value,
            startTime: document.getElementById('depl-start-time').value,
            endTime: document.getElementById('depl-end-time').value,
            injured: getDynamicListValues('depl-injured', true),
            suspects: getDynamicListValues('depl-suspects', true),
            civilians: getDynamicListValues('depl-civilians', true),
            signature: document.getElementById('depl-signature').value.trim(),
            timestamp: new Date().toISOString()
        };
        if (!deploymentReportData.members.length) {
            return showSnackbar("Error: Please fill in at least one member.");
        }
        if(saveReport(deploymentReportData)) {
            provideSaveFeedback(button);
        }
        const bbcode = buildDeploymentBBCode(deploymentReportData);
        const outputContainer = document.getElementById("deployment-output-container");
        document.getElementById("deployment-output").textContent = bbcode;
        outputContainer.style.display = 'block';
        outputContainer.scrollIntoView({ behavior: 'smooth' });
        localStorage.removeItem(deploymentFormKey);
        document.getElementById("deployment-form").reset();
        document.querySelectorAll('#deployment-form .dynamic-list-container').forEach(c => c.innerHTML = '');
    }

    // --- QUICK PARSER LOGIC ---
    function parseAndSaveQuickReport(button) {
        const reportData = {
            type: 'Deployment',
            deploymentType: document.getElementById('parser-deployment-type').value,
            members: document.getElementById('parser-personnel-input').value.split('\n').map(line => line.trim()).filter(Boolean),
            timeline: document.getElementById('parser-timeline-input').value,
            timestamp: new Date().toISOString()
        };
        if (!reportData.members.length || !reportData.timeline) {
            return showSnackbar("Error: Please fill Personnel and Timeline fields.");
        }
        const dateMatch = reportData.timeline.match(/2\.1\s+DATE:\s*(.*)/i);
        const startMatch = reportData.timeline.match(/START OF DEPLOYMENT:\s*(\d{2}:\d{2})/i);
        const endMatch = reportData.timeline.match(/END OF DEPLOYMENT:\s*(\d{2}:\d{2})/i);
        if (!dateMatch || !startMatch || !endMatch) {
            return showSnackbar("Error: Could not parse timeline format.");
        }
        reportData.date = dateMatch[1].trim();
        reportData.startTime = startMatch[1].trim();
        reportData.endTime = endMatch[1].trim();
        
        if(saveReport(reportData)) {
            provideSaveFeedback(button);
        }
        document.getElementById('parser-personnel-input').value = '';
        document.getElementById('parser-timeline-input').value = '';
    }
    
    // --- SUMMARY & VIEWING LOGIC ---
    function generateSummary() {
        const reports = JSON.parse(localStorage.getItem(reportStorageKey)) || [];
        const summaryOutputContainer = document.getElementById('summary-output-container');
        const summaryOutput = document.getElementById('summary-output');
        const exclusionInput = document.getElementById('summary-name-exclusion').value;
        localStorage.setItem(summaryExclusionKey, exclusionInput);
        const exclusionNames = exclusionInput.split(',').map(name => name.trim().toLowerCase()).filter(Boolean);

        if (reports.length === 0) {
            summaryOutput.innerHTML = "<h3>No reports found.</h3>";
            summaryOutputContainer.style.display = 'block';
            return;
        }

        const reportsByMonth = reports.reduce((acc, report) => {
            try {
                if (!report.date || report.date.split('/').length !== 3) return acc;
                const dateParts = report.date.split('/');
                const monthNum = new Date(Date.parse(dateParts[1] + " 1, 2012")).getMonth() + 1;
                const year = dateParts[2];
                const monthKey = `${year}-${String(monthNum).padStart(2, '0')}`;
                if (!acc[monthKey]) acc[monthKey] = [];
                acc[monthKey].push(report);
            } catch (e) {
                console.warn("Could not parse date for report, skipping. Report:", report);
            }
            return acc;
        }, {});

        const sortedMonths = Object.keys(reportsByMonth).sort().reverse();
        let finalOutputHTML = '';

        sortedMonths.forEach(monthKey => {
            const monthlyReports = reportsByMonth[monthKey];
            const monthDate = new Date(monthKey + '-02T00:00:00Z');
            const monthName = monthDate.toLocaleString('default', { month: 'long', timeZone: 'UTC' });
            const year = monthDate.getUTCFullYear();
            let patrolCount = 0, deploymentCount = 0, totalDeploymentMinutes = 0;
            const partnerCounts = {}, deploymentTypeCounts = {};
            const getFullName = (str) => {
                const parts = (str || "").trim().split(' ');
                return parts.length >= 2 ? parts.slice(-2).join(' ') : str;
            };

            monthlyReports.forEach(report => {
                try {
                    let participants = [];
                    if (report.type === 'Patrol') {
                        patrolCount++;
                        participants = report.officers || [];
                    } else if (report.type === 'Deployment') {
                        deploymentCount++;
                        participants = report.members || [];
                        const depType = report.deploymentType || 'Unknown';
                        deploymentTypeCounts[depType] = (deploymentTypeCounts[depType] || 0) + 1;
                        if (report.startTime && report.endTime && report.date) {
                            const dateParts = report.date.split('/');
                            const monthNum = new Date(Date.parse(dateParts[1] + " 1, 2012")).getMonth() + 1;
                            const isoDate = `${dateParts[2]}-${String(monthNum).padStart(2,'0')}-${String(dateParts[0]).padStart(2,'0')}`;
                            const start = new Date(`${isoDate}T${report.startTime}:00Z`);
                            const end = new Date(`${isoDate}T${report.endTime}:00Z`);
                            if (end > start) totalDeploymentMinutes += (end - start) / (1000 * 60);
                        }
                    }
                    participants.forEach(p => {
                        const originalPartnerFullName = getFullName(p);
                        const partnerFullNameLower = originalPartnerFullName.toLowerCase();
                        if (!exclusionNames.includes(partnerFullNameLower)) {
                            partnerCounts[originalPartnerFullName] = (partnerCounts[originalPartnerFullName] || 0) + 1;
                        }
                    });
                } catch (e) {
                    console.error("Failed to process a report, skipping. Report data:", report, "Error:", e);
                }
            });
            
            const sortedPartners = Object.entries(partnerCounts).sort(([, a], [, b]) => b - a);
            const sortedDeploymentTypes = Object.entries(deploymentTypeCounts).sort(([, a], [, b]) => b - a);

            finalOutputHTML += `<hr><h3>Summary for ${monthName} ${year}</h3>`;
            finalOutputHTML += `<ul><li><strong>Total Patrols Logged:</strong> ${patrolCount}</li><li><strong>Total Deployments Logged:</strong> ${deploymentCount}</li><li><strong>Total Deployment Duration:</strong> ${(totalDeploymentMinutes / 60).toFixed(1)} hours</li></ul>`;
            if (sortedDeploymentTypes.length > 0) {
                finalOutputHTML += `<h4>Deployment Types Breakdown:</h4><ol>`;
                sortedDeploymentTypes.forEach(([type, count]) => finalOutputHTML += `<li>${type} (${count})</li>`);
                finalOutputHTML += `</ol>`;
            }
            finalOutputHTML += `<h4>Partnership Summary:</h4>`;
            if (sortedPartners.length > 0) {
                finalOutputHTML += `<ol>`;
                sortedPartners.forEach(([name, count]) => finalOutputHTML += `<li>${name} (${count} times)</li>`);
                finalOutputHTML += `</ol>`;
            } else {
                finalOutputHTML += `<p>No partners recorded this month.</p>`;
            }
        });
        summaryOutput.innerHTML = finalOutputHTML.length > 5 ? finalOutputHTML.substring(5) : "<h3>No reports to summarize.</h3>";
        summaryOutputContainer.style.display = 'block';
        summaryOutputContainer.scrollIntoView({ behavior: 'smooth' });
    }

    function displayAllReports() {
        const container = document.getElementById('all-reports-container');
        const reports = JSON.parse(localStorage.getItem(reportStorageKey)) || [];
        container.innerHTML = '';
        if (reports.length === 0) {
            container.innerHTML = "<p>No reports have been saved yet.</p>";
            return;
        }
        reports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        reports.forEach(report => {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'report-entry';
            
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'report-details';
            detailsDiv.innerHTML = `<p class="report-meta">${report.type} Report | ${report.date || 'No Date'}</p>
                                  <p><strong>Participants:</strong> ${(report.officers || report.members || []).join(', ')}</p>`;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'report-actions';

            if (report.deploymentType || report.patrolTypes) {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy BBCode';
                copyBtn.onclick = (e) => {
                    let bbcode = report.type === 'Patrol' ? buildPatrolBBCode(report) : buildDeploymentBBCode(report);
                    copyToClipboard(bbcode, e.target);
                };
                actionsDiv.appendChild(copyBtn);
            }
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'danger-btn';
            deleteBtn.textContent = 'Delete';
            deleteBtn.onclick = () => deleteReport(report.timestamp);
            
            actionsDiv.appendChild(deleteBtn);
            entryDiv.appendChild(detailsDiv);
            entryDiv.appendChild(actionsDiv);
            container.appendChild(entryDiv);
        });
    }
</script>
</body>
</html>